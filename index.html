<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>TV por Cable</title>
    <script src="lib/babel.min.js"></script>
    <script src="lib/react.production.min.js"></script>
    <script src="lib/react-dom.production.min.js"></script>
    <script src="lib/prop-types.min.js"></script>
    <script src="lib/reactstrap.full.min.js"></script>
    <link rel="stylesheet" href="lib/css/bootstrap.min.css"></link>
    <link rel="stylesheet" href="lib/css/styles.css"></link>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        
        var Container = Reactstrap.Container;
        var Row = Reactstrap.Row;
        var Col = Reactstrap.Col;
        var TableStrap = Reactstrap.Table;
        var Navbar = Reactstrap.Navbar;
        var NavbarBrand = Reactstrap.NavbarBrand;
        var Nav = Reactstrap.Nav;
        var NavItem = Reactstrap.NavItem;
        var NavLink = Reactstrap.NavLink;
        var Input = Reactstrap.Input;
        var Button = Reactstrap.Button;
        
        const databases = [
        {
          name: "facturas",
          fields: {
            id: { type: "number" },
            fecha: { type: "date" },
            cliente: { type: "string" },
          }
        },
        {
          name: "database#2",
          fields: {
            name: { type: "string" },
            bornDate: { type: "date" },
            info: { type: "string" }
          }
        }
      ];
      
      function setFieldByType(typeOf, value) {
        if (!typeOf) return value;
        if (typeOf === "date") return new Date(value).toDateString();

        return value;
      }

      class App extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            data: [],
            databases,
            selectedDB: databases[0],
            selectedItem: undefined
          };
        }

        componentWillReceiveProps() {}
        
        componentWillMount(){
            this.onGetData()
        }

        render() {
          const { selectedDB, databases, data, selectedItem } = this.state;
          return (
            <div>
              <header>            
                <Navbar color="light" light expand="md">
                    <NavbarBrand href="/">TV por Cable</NavbarBrand>
                </Navbar>
                <Nav>
                    {databases.map((DB) => (
                            <NavItem onClick={() => this.onSelectDataBase(DB)}>
                                <NavLink>{DB.name}</NavLink>
                            </NavItem>))}
                  </Nav>
               
                
              </header>  
              <Container fluid>
                <Row>
                    <Col>
                        <Table
                          data={data}
                          database={selectedDB}
                          onSelectItem={this.onSelectItem}
                        />
                    </Col>
                    <Col>
                        <Form
                            database={selectedDB}
                            onAddData={this.onAddData}
                            onSetData={this.onSetData}
                            onDelData={this.onDelData}
                            selectedItem={selectedItem}
                        />
                   </Col> 
                </Row>
              </Container>  
            </div>
          );
        }
        onSelectDataBase = selectedDB => {
            this.setState({ selectedDB })
        }
        onGetData = () => {
            const { selectedDB } = this.state
            
            fetch(`http://localhost/Lic/trabajo09/hello.php/${selectedDB.name}`)
                .then((res) => {
                    return res.json();
                })
                .then((data) => {
                    this.setState({data});
                    console.log('data',data)
                })
        }
        
        onFact = (args) => {
            console.log(args)
            const { selectedDB } = this.state
            fetch(`http://localhost/Lic/trabajo09/hello.php/${selectedDB.name}`, {
                method: "post",
                headers: {'Content-Type': 'application/json',
                                   'Content-Length': 20},
                body: JSON.stringify({...args})
            }).then((res) => {
                    return res.json();
                })
                .then((data) => {
                    console.log('data',data)
                })
        }
            
        onAddData = newItem => {
          const { data } = this.state;
          this.onFact({ ...newItem })
          this.setState({ data: [...data, { ...newItem }] });
        };

        onSetData = newItem => {
          const { data } = this.state;
          const newData = data.filter(({ id }) => id !== newItem.id);

          this.setState({
            data: [...newData, { ...newItem }],
            selectedItem: undefined
          });
        };

        onDelData = item => {
          const { data } = this.state;
          const newData = data.filter(({ id }) => id !== item.id);

          this.setState({
            data: [...newData],
            selectedItem: undefined
          });
        };

        onSelectItem = item => {
          this.setState({ selectedItem: { ...item } });
        };
      }
      
      class Table extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            database: props.database,
            data: props.data || []
          };
        }

        componentWillReceiveProps(nextProps) {
          const { database, data } = nextProps;
          this.setState({ database, data });
        }

        render() {
          const { database, data } = this.state;

          if (!database) return <h2>Loading...</h2>;

          const { name, fields } = database;
          const { onSelectItem } = this.props;

          return (
            <div>
              <h1>Table :{name}</h1>
              <TableStrap borderless>
                <TableHeader fields={fields} />
                <TableBody fields={fields} data={data} onSelectItem={onSelectItem} />
              </TableStrap>
            </div>
          );
        }
      }

      const TableHeader = ({ fields }) => {
        return <thead>{Object.keys(fields).map(key => <th>{key}</th>)}</thead>;
      };

      const TableBody = ({ fields, data, onSelectItem }) => {
        return (
          <tbody>
            {data.map(row => (
              <tr key={row.id} onClick={() => onSelectItem({ ...row })}>
                {Object.keys(fields).map(key => {
                  const { type: typeOf } = fields[key];
                  const value = setFieldByType(typeOf, row[key]);
                  return <td>{value}</td>;
                })}
              </tr>
            ))}
          </tbody>
        );
      };
  
    class Form extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          database: props.database,
          fieldsData: {}
        };
      }

      componentWillReceiveProps(nextProps) {
        const { database, selectedItem } = nextProps;
        const { fields = {} } = database;

        const nextFields = Object.keys(fields).reduce((acc, key) => {
          acc[key] = selectedItem ? selectedItem[key] : "";
          return acc;
        }, {});

        this.setState({ database, fieldsData: nextFields });
      }

      render() {
        const { database, fieldsData } = this.state;

        if (!database) return <h2>Loading...</h2>;

        const { name, fields } = database;
        const { selectedItem } = this.props;

        return (
          <div>
            <h1>Form : {name}</h1>
            <TableStrap borderless>
              {Object.keys(fields).map(key => {
                const { type: typeOf } = fields[key];
                return (
                  <tr>
                    <td>{key}</td>
                    <td>
                      <Input
                        name={key}
                        type={typeOf}
                        value={fieldsData[key]}
                        onChange={this.handleOnChangeFieldData}
                      />
                    </td>
                  </tr>
                );
              })}
            </TableStrap>
            {!selectedItem ? (
              <Button color="primary"
                onClick={() => {
                  const { fieldsData } = this.state;
                  this.props.onAddData({ ...fieldsData });
                  this.setState({ fieldsData: {} });
                }}
              >
                Add
              </Button>
            ) : (<div>
              <Button color="primary"
                onClick={() => {
                  const { fieldsData } = this.state;
                  this.props.onSetData({ ...fieldsData });
                  this.setState({ fieldsData: {} });
                }}
              >
                Set
              </Button>
                <Button color="primary"
                  onClick={() => {
                    const { fieldsData } = this.state;
                    this.props.onDelData({ ...fieldsData });
                    this.setState({ fieldsData: {} });
                  }}
                >
                  Del
              </Button>
              </div>
            )}
          </div>
        );
      }

      handleOnChangeFieldData = e => {
        const { fieldsData } = this.state;
        const newValue = e.target.value;
        const field = e.target.name;
        const newFieldsData = { ...fieldsData, [field]: newValue };

        this.setState({ fieldsData: newFieldsData });
      };
    }
    
    ReactDOM.render(<App />, document.getElementById("root"));
    </script>

</body>

</html>